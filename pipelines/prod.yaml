# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  branches:
    include:
      - releases/*

resources:
  repositories:
    - repository: deployment-repo
      type: git
      name: TripOTAFramework/TripOTA.Deployment
      ref: release
      persistCredentials: true

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: "HNH PROD ARC 1"
  imageRepository: "tmc-booker-react-prod"
  imageRepositoryUAT: "tmc-booker-react-uat"
  containerRegistry: "hnhprodarc.azurecr.io"
  containerName: "tmc-booker-react"
  dockerfilePath: "$(Build.SourcesDirectory)/Dockerfile"
  dockerfilePathUAT: "$(Build.SourcesDirectory)/Dockerfile.uat"
  tag: "$(Build.SourceBranchName)-$(Build.BuildId)"
  componentName: "TMC Booker React"

pool:
  name: "Default"

stages:
  - stage: Build
    displayName: Build and push stage
    jobs:
      - job: Build
        displayName: Build
        steps:
          - checkout: self
            lfs: true
            submodules: recursive

          - task: Docker@2
            displayName: Build an image to container registry [PROD]
            inputs:
              command: build
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(dockerRegistryServiceConnection)
              arguments: '--build-arg ENVIRONMENT=production'
              tags: |
                $(tag)

          - task: Docker@2
            displayName: Push an image to container registry
            inputs:
              command: push
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)

          - task: Docker@2
            displayName: Build an image to container registry [UAT]
            inputs:
              command: build
              repository: $(imageRepositoryUAT)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(dockerRegistryServiceConnection)
              arguments: '--build-arg ENVIRONMENT=uat'
              tags: |
                $(tag)

          - task: Docker@2
            displayName: Push an image to container registry
            inputs:
              command: push
              repository: $(imageRepositoryUAT)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
